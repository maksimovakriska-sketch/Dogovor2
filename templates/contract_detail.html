{% extends "base.html" %}
{% block content %}
<h2>Договор: {{ contract.contract_number }}</h2>

<div class="mb-2 d-flex justify-content-between">
  <div>
    {% if contract.parent_id %}
      <div class="alert alert-info">
        Это доп. соглашение к договору
        <a href="{{ url_for('main.contract_detail', cid=contract.parent_id) }}">#{{ contract.parent.contract_number }}</a>.
        {% if contract.extra_type == 'add_amount' %}
          Тип: Доп. сумма — {{ '%.2f'|format(contract.amount_total or 0) }}
        {% elif contract.extra_type == 'termination' %}
          Тип: Досрочное расторжение
        {% endif %}
      </div>
    {% endif %}
  </div>

  <div>
    <a class="btn btn-secondary" href="{{ url_for('main.contracts') }}">← Назад</a>
    {% if current_user.is_admin or contract.user_id == current_user.id %}
      <a class="btn btn-outline-primary" href="{{ url_for('main.contract_edit', cid=contract.id) }}">Редактировать</a>

      <form method="post" action="{{ url_for('main.contract_archive', cid=contract.id) }}" style="display:inline;" onsubmit="return confirmAction(this,'Переместить договор #{{ contract.contract_number }} в архив?');">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <button class="btn btn-warning">В архив</button>
      </form>

      <form method="post" action="{{ url_for('main.contract_delete', cid=contract.id) }}" style="display:inline;" onsubmit="return confirmAction(this,'Удалить договор #{{ contract.contract_number }}? Это действие необратимо.');">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <button class="btn btn-danger">Удалить</button>
      </form>
    {% endif %}
  </div>
</div>

<div class="row mb-3">
  <div class="col-md-6">
    <b>Дата договора:</b> {{ contract.contract_date.strftime('%d.%m.%Y') }}<br>
    <b>Контрагент:</b> {{ contract.contractor }}<br>
    <b>Вид оплаты:</b> {{ contract.payment_type }}<br>
    <b>Тип:</b> {{ contract.main_or_additional }}<br>
  </div>
  <div class="col-md-6">
    <b>Сумма договора:</b> {{ '%.2f'|format(contract.amount_total or 0) }}<br>
    <b>Оплачено:</b> {{ '%.2f'|format(contract.amount_paid or 0) }}<br>
    <b>Выработано:</b> {{ '%.2f'|format(contract.amount_earned or 0) }}<br>
    <b>Остаток:</b> {{ '%.2f'|format((contract.amount_total or 0) - (contract.amount_earned or 0)) }}<br>
    <b>Статус:</b>
      {% if contract.status == 'исполнен' %}
        <span class="badge bg-success">Исполнен</span>
      {% elif contract.status == 'расторгнут' %}
        <span class="badge bg-danger">Расторгнут</span>
      {% else %}
        <span class="badge bg-secondary">{{ contract.status }}</span>
      {% endif %}
  </div>
</div>

{# Sub agreements #}
{% if subs %}
<h4>Дополнительные соглашения</h4>
<table class="table table-bordered">
  <thead>
    <tr>
      <th>Номер</th>
      <th>Тип</th>
      <th class="text-end">Сумма</th>
      <th class="text-end">Оплачено</th>
      <th>Статус</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    {% for sub in subs %}
      <tr>
        <td>#{{ sub.contract_number }}</td>
        <td>{% if sub.extra_type == 'add_amount' %}Доп. сумма{% elif sub.extra_type == 'termination' %}Растор.{% else %}—{% endif %}</td>
        <td class="text-end">{{ '%.2f'|format(sub.amount_total or 0) }}</td>
        <td class="text-end">{{ '%.2f'|format(sub.amount_paid or 0) }}</td>
        <td>
          {% if sub.status == 'расторгнут' %}<span class="badge bg-danger">Расторгнут</span>{% else %}{{ sub.status }}{% endif %}
        </td>
        <td class="text-end">
          <!-- единая кнопка для перехода к доп. соглашению -->
          <a class="btn btn-sm btn-outline-primary" href="{{ url_for('main.contract_detail', cid=sub.id) }}" title="Открыть доп. соглашение #{{ sub.contract_number }}">Открыть ↗</a>
        </td>
      </tr>
    {% endfor %}
  </tbody>
</table>
{% endif %}

<hr>
<h4>История оказанных услуг</h4>
<table class="table table-bordered">
  <thead>
    <tr><th>Дата</th><th>Описание</th><th class="text-end">Сумма</th></tr>
  </thead>
  <tbody>
    {% for s in services %}
      <tr>
        <td>{{ s.date_display }}</td>
        <td>
          {% if s.is_extra %}
            <span class="badge bg-info me-1">Доп. услуга</span>
          {% endif %}
          {{ s.description }}
        </td>
        <td class="text-end">{{ '%.2f'|format(s.total or 0) }}</td>
      </tr>
    {% endfor %}
  </tbody>
</table>

<hr>
<h4>История изменений и оплат</h4>
{% if history %}
  <table class="table table-borderless table-sm">
    <thead><tr><th>Дата</th><th>Действие</th><th>Кто</th></tr></thead>
    <tbody>
      {% for h in history %}
        <tr>
          <td style="width:160px;">{{ h.date.strftime('%d.%m.%Y %H:%M') if h.date else '-' }}</td>
          <td>{{ h.action }}</td>
          <td>{{ h.actor or '-' }}</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
{% else %}
  <div class="alert alert-light">История отсутствует.</div>
{% endif %}

<hr>
<h4>Добавить услугу / доп. услугу / оплату</h4>
<div class="row">
  <div class="col-md-4">
    <form method="post">
      {{ service_form.hidden_tag() }}
      <input type="hidden" name="form_name" value="service">
      <div class="mb-2">{{ service_form.date.label }} {{ service_form.date(class="form-control", type="date") }}</div>
      <div class="mb-2">{{ service_form.description.label }} {{ service_form.description(class="form-control") }}</div>
      <div class="mb-2">{{ service_form.quantity.label }} {{ service_form.quantity(class="form-control") }}</div>
      <div class="mb-2">{{ service_form.price_per_unit.label }} {{ service_form.price_per_unit(class="form-control") }}</div>
      <div>{{ service_form.submit(class="btn btn-info") }}</div>
    </form>
  </div>
  <div class="col-md-4">
    <form method="post">
      {{ extra_service_form.hidden_tag() }}
      <input type="hidden" name="form_name" value="extra_service">
      <div class="mb-2">{{ extra_service_form.date.label }} {{ extra_service_form.date(class="form-control", type="date") }}</div>
      <div class="mb-2">{{ extra_service_form.description.label }} {{ extra_service_form.description(class="form-control") }}</div>
      <div class="mb-2">{{ extra_service_form.price.label }} {{ extra_service_form.price(class="form-control") }}</div>
      <div class="mb-2">{{ extra_service_form.total.label }} {{ extra_service_form.total(class="form-control") }}</div>
      <div>{{ extra_service_form.submit(class="btn btn-info") }}</div>
    </form>
  </div>
  <div class="col-md-4">
    <form method="post">
      {{ payment_form.hidden_tag() }}
      <input type="hidden" name="form_name" value="payment">
      <div class="mb-2">{{ payment_form.date.label }} {{ payment_form.date(class="form-control", type="date") }}</div>
      <div class="mb-2">{{ payment_form.amount_paid.label }} {{ payment_form.amount_paid(class="form-control") }}</div>
      <div>{{ payment_form.submit(class="btn btn-success") }}</div>
    </form>
  </div>
</div>
{% endblock %}